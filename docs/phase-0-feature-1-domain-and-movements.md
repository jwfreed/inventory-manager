# Phase 0 — Feature 1: Domain Model + Inventory Movement Schema (Docs Only)

This document defines the **domain model** and **inventory movement schema** for `inventory-manager`.
It is **documentation only** (no migrations, no ORM models, no runtime implementation).

## Scope

The schema supports:
- Multiple items/SKUs.
- Multiple locations (warehouses, bins, trucks, etc.).
- A full audit trail of inventory changes via immutable movements.
- On-hand derived as the sum of posted movement lines.

Out of scope for Phase 0:
- Pricing, valuation (FIFO/LIFO), costing layers.
- Reservations/allocations.
- Serial/lot tracking (can be added later).

## Core Concepts

### Inventory Is Event-Sourced (Ledger)

Inventory is not stored as a mutable “quantity” field. Instead, inventory is derived from an append-only ledger:
- A **Movement** is a business event (Receive, Issue, Transfer, Adjustment, Count).
- A **Movement Line** is a single atomic delta affecting one `(item, location)` pair.
- Posting a movement makes its lines effective; posted movements are immutable.

### Posting Model

- `draft` movements can be edited and deleted.
- `posted` movements cannot be changed; corrections are made by new movements.
- (Optional later) `voided` can exist if you need to cancel a draft; posted should not be voided without an explicit reversal movement.

### Atomic Posting (Clarification)

Posting is **atomic at the movement level**:
- A movement transitions from `draft` → `posted` in a single operation.
- Either **all** of its lines become effective together, or **none** do.
- Partial posting of a subset of lines is not supported in this model.

## Domain Model (Logical)

### Entities

- **Item**
  - What you stock (e.g., “AA Battery”).
  - May be tracked as SKU(s).
- **Location**
  - Where you stock (warehouse, bin, store, customer, scrap, etc.).
- **Inventory Movement**
  - A business transaction that causes inventory to change.
- **Inventory Movement Line**
  - The per-item delta(s) for a movement.

### Relationships

- `Item (1) -> (N) MovementLine`
- `Location (1) -> (N) MovementLine`
- `Movement (1) -> (N) MovementLine`

## Inventory Movement Schema (Proposed Relational Schema)

Assumes PostgreSQL types. All timestamps are UTC.

ID generation (Phase 0 assumption):
All primary keys are UUIDs. IDs may be generated by the application (recommended for offline-capable clients) or by the database default (e.g., `gen_random_uuid()`), but the implementation must choose one consistent approach. Phase 0 documents UUID usage only; the generation mechanism is decided during implementation.

### `items`

| Column | Type | Null | Notes |
|---|---:|:---:|---|
| `id` | `uuid` | no | PK |
| `sku` | `text` | no | Unique business identifier (human-facing) |
| `name` | `text` | no | |
| `description` | `text` | yes | |
| `active` | `boolean` | no | default true |
| `created_at` | `timestamptz` | no | default now() |
| `updated_at` | `timestamptz` | no | |

Constraints / indexes:
- `unique (sku)`
- `index (active)`

### `locations`

| Column | Type | Null | Notes |
|---|---:|:---:|---|
| `id` | `uuid` | no | PK |
| `code` | `text` | no | Unique business identifier (e.g., `WH1-BIN-A3`) |
| `name` | `text` | no | |
| `type` | `text` | no | enum-like: `warehouse`, `bin`, `store`, `customer`, `vendor`, `scrap`, `virtual` |
| `active` | `boolean` | no | default true |
| `created_at` | `timestamptz` | no | default now() |
| `updated_at` | `timestamptz` | no | |

Constraints / indexes:
- `unique (code)`
- `index (type)`
- `index (active)`

### `inventory_movements`

Represents the business event; immutable after posting.

| Column | Type | Null | Notes |
|---|---:|:---:|---|
| `id` | `uuid` | no | PK |
| `movement_type` | `text` | no | enum-like: `receive`, `issue`, `transfer`, `adjustment`, `count` |
| `status` | `text` | no | enum-like: `draft`, `posted` |
| `external_ref` | `text` | yes | Optional upstream reference (PO, SO, ticket id) |
| `occurred_at` | `timestamptz` | no | Business-effective time |
| `posted_at` | `timestamptz` | yes | Set when status becomes `posted` |
| `notes` | `text` | yes | |
| `created_at` | `timestamptz` | no | default now() |
| `updated_at` | `timestamptz` | no | |

Constraints / indexes:
- `check (status in ('draft','posted'))`
- `check (movement_type in ('receive','issue','transfer','adjustment','count'))`
- `index (status)`
- `index (movement_type, occurred_at)`
- `index (external_ref)` (optional)

### `inventory_movement_lines`

Atomic deltas. Quantity sign convention is **positive increases on-hand** at that location, **negative decreases**.

| Column | Type | Null | Notes |
|---|---:|:---:|---|
| `id` | `uuid` | no | PK |
| `movement_id` | `uuid` | no | FK → `inventory_movements(id)` |
| `item_id` | `uuid` | no | FK → `items(id)` |
| `location_id` | `uuid` | no | FK → `locations(id)` |
| `quantity_delta` | `numeric(18,6)` | no | Can be negative; must be non-zero |
| `uom` | `text` | no | Default unit (e.g., `each`, `kg`) |
| `reason_code` | `text` | yes | For adjustments/count deltas (e.g., `damage`, `shrink`) |
| `line_notes` | `text` | yes | |
| `created_at` | `timestamptz` | no | default now() |

#### UOM assumptions (Phase 0)

- Each Item has a conceptual default/canonical UOM (not necessarily stored yet).
- Inventory balances are computed per `(item_id, location_id, uom)`. Mixed-UOM lines for the same item/location are not summed together; they represent separate balances.
- Unit conversions are explicitly out of scope for Phase 0.

Constraints / indexes:
- `check (quantity_delta <> 0)`
- `index (movement_id)`
- `index (item_id, location_id)`
- `index (location_id, item_id)` (optional for query plans)

### Negative On-hand (Explicit Stance)

This Phase 0 schema **permits negative on-hand** (the ledger can sum to a negative quantity) because:
- It supports backdated posting, data correction, and “issue before receive” workflows.
- Enforcement of “no negatives” is a policy concern and may vary by location/type.

If a future phase requires it, add a posting-time validation policy such as:
- Disallow posting movements that would take any `(item, location, uom)` below zero (except for configured virtual locations), or
- Allow negatives but emit warnings/alerts.

### Movement Semantics (How Lines Must Look)

Note: These invariants cannot be fully enforced with basic relational constraints; they are enforced at posting time, atomically with status transition to `posted`.

#### `receive`
- Increases stock into a location.
- Posting-time validation (application/service layer): all `quantity_delta` must be **> 0**.

#### `issue`
- Decreases stock from a location.
- Posting-time validation (application/service layer): all `quantity_delta` must be **< 0**.

#### `transfer`
- Moves stock from one location to another.
- Posting-time validation (application/service layer): movement must be balanced (sum of `quantity_delta` across all lines = `0`) and typically represented as matching `(-x, +x)` pairs per `(item_id, uom)` across source/destination locations.
  - Example: `-5` at `LOC_A`, `+5` at `LOC_B` for the same `(item, uom)`.

#### `adjustment`
- Arbitrary delta (positive or negative) to correct stock.
- Schema rule: deltas can be either sign; `reason_code` recommended.

#### `count` (Cycle Count / Stocktake Adjustment)
- Represents a counted result that produces a correction delta.
- Schema options:
  - **Option A (delta-only)**: lines are correction deltas like adjustment, but `movement_type='count'`.
  - **Option B (counted quantity + derived delta)**: add `counted_quantity` column and compute delta when posting.
- For Phase 0 docs, adopt **Option A (delta-only)** to keep schema minimal.

### Derived Values

#### On-hand quantity

For any `(item_id, location_id, uom)`, on-hand is:
- Sum of `quantity_delta` across all lines whose parent movement is `posted`.

Pseudo-query:
- `SELECT sum(l.quantity_delta) FROM inventory_movement_lines l JOIN inventory_movements m ON m.id=l.movement_id WHERE m.status='posted' AND l.item_id=? AND l.location_id=? AND l.uom=?`

#### Item total on-hand
- Sum across locations (same filter).

## Optional “Read Model” (Later, Not Phase 0)

If performance requires it later, add a materialized/denormalized table like `inventory_balances`:
- Populated by background jobs / triggers.
- Always reconcilable to the ledger.

## Acceptance Criteria (Schemas Only)

1. Documentation exists that defines entities: `Item`, `Location`, `InventoryMovement`, `InventoryMovementLine`.
2. Documentation defines table schemas including columns, types, nullability, and constraints for:
   - `items`
   - `locations`
   - `inventory_movements`
   - `inventory_movement_lines`
3. Documentation defines movement types and required line semantics for `receive`, `issue`, `transfer`, `adjustment`, `count`.
4. Documentation defines the sign convention for `quantity_delta` and the canonical “on-hand is sum of posted deltas” rule.
5. No production code is added (no migrations executed, no ORM/runtime model implementation).
